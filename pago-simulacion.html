<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pago simulado — Tropics Hotel</title>
  <meta name="description" content="Simulación segura de pago para completar tu reserva en modo de prueba." />
  <style>
    /* Reset y tipografía */
    :root{
      --bg:#f6f8fb; --card:#ffffff; --accent:#0b7cff; --muted:#6b7280;
      --success:#16a34a; --danger:#ef4444;
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f6f8fb,#eef4ff);color:#0f172a;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:100%;max-width:760px;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(12,35,64,0.08);padding:26px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    .brand{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6fb3ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 16px;color:var(--muted);font-size:14px}

    form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}
    label{display:block;font-size:13px;margin-bottom:6px;color:#111827}
    input,select,button,textarea{
      width:100%;padding:12px;border:1px solid #e6e9ef;border-radius:10px;font-size:14px;
      background:transparent;outline:none;transition:box-shadow .12s ease,border-color .12s ease;
    }
    input:focus,select:focus,textarea:focus{box-shadow:0 4px 14px rgba(11,124,255,0.08);border-color:var(--accent)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:14px}
    .btn{background:var(--accent);color:white;padding:12px 16px;border-radius:10px;border:0;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,124,255,0.12)}
    .notice{padding:10px;border-radius:8px;background:#f8fafc;border:1px solid #eef2ff;color:var(--muted);font-size:13px;margin-bottom:12px}
    .spinner{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.18);border-top-color:rgba(255,255,255,0.9);animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .result{display:none;gap:12px;align-items:center;padding:14px;border-radius:10px;margin-top:12px}
    .result.success{background:rgba(22,163,74,0.12);border:1px solid rgba(22,163,74,0.18);color:var(--success);display:flex}
    .result.error{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.12);color:var(--danger);display:flex}
    footer.small{font-size:12px;color:var(--muted);margin-top:12px;text-align:center}

    @media (max-width:640px){ form{grid-template-columns:1fr} .brand{width:48px;height:48px}}
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <header>
      <div class="brand">TH</div>
      <div>
        <h1 id="title">Simulación de pago — Tropics Hotel</h1>
        <p class="lead">Completa los datos de la simulación para finalizar tu reserva (modo prueba).</p>
      </div>
    </header>

    <div class="notice">
      Esta es una <strong>simulación</strong>. No se realizará ningún cobro real. Usa datos ficticios (número de tarjeta de 16 dígitos).
    </div>

    <form id="simForm" autocomplete="off" novalidate>
      <div class="full">
        <label for="holder">Nombre y apellido (titular)</label>
        <input id="holder" name="holder" type="text" placeholder="Ej: Juan Pérez" required />
        <div class="hint">Usa el mismo nombre que aparece en la pre-reserva.</div>
      </div>

      <div>
        <label for="email">Email de contacto</label>
        <input id="email" name="email" type="email" placeholder="correo@ejemplo.com" required />
      </div>

      <div>
        <label for="amount">Monto (USD)</label>
        <input id="amount" name="amount" type="text" inputmode="decimal" placeholder="Ej: 120.00" required />
      </div>

      <div class="full">
        <label for="card">Número de tarjeta</label>
        <input id="card" name="card" type="text" inputmode="numeric" maxlength="19" placeholder="1234 5678 9012 3456" required />
        <div class="hint">Acepta cualquier 16 dígitos. Se formatea automáticamente.</div>
      </div>

      <div class="col">
        <label for="exp">Vencimiento (MM/AA)</label>
        <input id="exp" name="exp" type="text" inputmode="numeric" maxlength="5" placeholder="MM/AA" required />
      </div>

      <div class="col">
        <label for="cvv">CVV</label>
        <input id="cvv" name="cvv" type="password" inputmode="numeric" maxlength="3" placeholder="123" required />
      </div>

      <div class="full">
        <label for="address">Dirección (opcional)</label>
        <input id="address" name="address" type="text" placeholder="Calle, ciudad, código postal" />
      </div>

      <div class="full">
        <label for="notes">Notas (opcional)</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Información adicional..."></textarea>
      </div>

      <div class="actions full">
        <button id="cancelBtn" type="button" class="btn ghost">Cancelar</button>
        <button id="payBtn" class="btn" type="submit">Realizar el pago</button>
      </div>

      <div id="result" class="result" role="status" aria-live="polite"></div>
    </form>

    <footer class="small">
      <div>Si esta ventana fue abierta desde el chat, al completar el pago recibirás la confirmación en el chat.</div>
    </footer>
  </main>

  <script>
    (function(){
      // Util: obtener query param pre_res_id
      function qs(name){
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      const preResId = qs('pre_res_id') || null;
      const simForm = document.getElementById('simForm');
      const payBtn = document.getElementById('payBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const resultEl = document.getElementById('result');

      // Formato de tarjeta: inserta espacios cada 4 dígitos
      const cardInput = document.getElementById('card');
      cardInput.addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g,'').slice(0,16);
        let parts = v.match(/.{1,4}/g);
        e.target.value = parts ? parts.join(' ') : v;
      });

      // Vencimiento: MM/AA
      const expInput = document.getElementById('exp');
      expInput.addEventListener('input', e => {
        let v = e.target.value.replace(/\D/g,'').slice(0,4);
        if(v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
        e.target.value = v;
      });

      // CVV: solo 3 dígitos
      const cvvInput = document.getElementById('cvv');
      cvvInput.addEventListener('input', e => {
        e.target.value = e.target.value.replace(/\D/g,'').slice(0,3);
      });

      cancelBtn.addEventListener('click', () => {
        // Cierra la ventana si fue abierta desde el chat
        try { window.close(); } catch(e){ /* no-op */ }
      });

      function showResult(type, text){
        resultEl.className = 'result ' + type;
        resultEl.textContent = text;
        resultEl.style.display = 'flex';
      }

      function clearResult(){
        resultEl.style.display = 'none';
        resultEl.className = 'result';
        resultEl.textContent = '';
      }

      function disableUI(disabled){
        if(disabled){
          payBtn.setAttribute('disabled','disabled');
          payBtn.innerHTML = 'Procesando <span class="spinner" aria-hidden="true"></span>';
        } else {
          payBtn.removeAttribute('disabled');
          payBtn.innerHTML = 'Realizar el pago';
        }
      }

      // Simula un delay de 1.5s para "procesamiento"
      function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

      // MAIN: envío del formulario
      simForm.addEventListener('submit', async function(evt){
        evt.preventDefault(); clearResult();

        // Validaciones básicas (pueden extenderse)
        const holder = document.getElementById('holder').value.trim();
        const email = document.getElementById('email').value.trim();
        const card = cardInput.value.replace(/\s/g,'');
        const exp = expInput.value.trim();
        const cvv = cvvInput.value.trim();
        const amount = document.getElementById('amount').value.trim();

        if(!holder || !email || !card || !exp || !cvv || !amount){
          showResult('error','Por favor completa todos los campos obligatorios.');
          return;
        }
        if(!/^\d{16}$/.test(card)){
          showResult('error','Número de tarjeta inválido (debe tener 16 dígitos).');
          return;
        }
        if(!/^\d{2}\/\d{2}$/.test(exp)){
          showResult('error','Formato de vencimiento inválido (MM/AA).');
          return;
        }
        if(!/^\d{3}$/.test(cvv)){
          showResult('error','CVV inválido (3 dígitos).');
          return;
        }
        if(!/^\d+(\.\d{1,2})?$/.test(amount)){
          showResult('error','Monto inválido. Usa formato númerico, por ejemplo "120.00".');
          return;
        }

        disableUI(true);
        await sleep(1500); // animación realista

        // Payload que enviamos al opener (chat)
        const payload = {
          type: "SIM_PAY_DONE",
          id: preResId || null,
          status: "success",
          payment: {
            holder, email, card_mask: 'XXXX-XXXX-XXXX-' + card.slice(-4),
            amount, currency: 'USD', ts: new Date().toISOString()
          }
        };

        // Opcional: intentar notificar al backend (si existe endpoint)
        // Esto es útil si querés guardar el intento/pago simulado en la base de datos.
        try {
          // Si tu backend tiene un endpoint para registrar pagos simulados,
          // descomenta la siguiente fetch y ajusta la URL.
          /*
          await fetch('api/reservas/confirmar-simulado', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pre_res_id: payload.id, payment: payload.payment })
          });
          */
        } catch(err){
          // no interrumpimos el flujo si el backend no está presente
          console.warn('No se pudo notificar al backend (opcional):', err);
        }

        // Enviar postMessage al window.opener (el chat que abrió esta pestaña)
        try {
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage(payload, "*");
            showResult('success','Pago simulado OK. La ventana principal recibirá la confirmación.');
          } else {
            // Si no existe opener, mostramos un mensaje alternativo y copiamos payload a clipboard
            showResult('success','Pago simulado OK. No se detectó la ventana que abrió este simulador.');
            // Copiamos datos para facilitar pruebas
            try {
              await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
            } catch(e){}
          }
        } catch (err) {
          showResult('error','Ocurrió un error enviando la confirmación al chat: ' + (err.message || err));
          disableUI(false);
          return;
        }

        // Mostrar breve confirmación y cerrar la pestaña en 2s para buen UX
        await sleep(900);
        try { window.close(); } catch(e){}
      });

      // Si quieres depurar: muestra pre_res_id en el título
      if(preResId){
        document.title = 'Pago simulado — ' + preResId;
      }

      // Protección: si se accede directo sin opener y sin pre_res_id, avisar
      if(!preResId && (!window.opener || window.opener.closed)){
        // no bloquear, solo aviso pequeño
        const n = document.createElement('div');
        n.className = 'notice';
        n.style.marginTop = '12px';
        n.textContent = 'Atención: no se detectó pre_res_id ni ventana originadora. Úsalo desde el chat para completar pruebas E2E.';
        document.querySelector('.card').insertBefore(n, document.querySelector('.card').children[2]);
      }
    })();
  </script>
</body>
</html>
