<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulación - Cliente ↔ Chatbot ↔ Agente</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e3a8a;
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.18);
      --border: rgba(255,255,255,.22);
      --bot:#e0f2fe; --botText:#082f49;
      --user:#fef3c7; --userText:#7c2d12;
      --agent:#c7d2fe; --agentText:#111827;
      --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Segoe UI", Roboto, Inter, system-ui, -apple-system, Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color:#fff;
      display:flex; align-items:center; justify-content:center;
      padding:20px 20px 84px; /* espacio para el botón inferior */
    }
    .wrap{
      width: min(1100px, 100%);
      height: min(86vh, 780px);
      display:grid; grid-template-columns: 1.15fr .85fr;
      gap:20px;
    }
    .card{
      background: var(--glass);
      border:1px solid var(--border);
      border-radius:16px;
      display:flex; flex-direction:column;
      box-shadow: 0 10px 30px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .head{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; background: var(--glass2); border-bottom:1px solid var(--border);
    }
    .head .title{font-weight:800; letter-spacing:.3px}
    .sub{font-size:12px; opacity:.85}
    .log{flex:1; padding:14px 16px; overflow:auto; display:flex; flex-direction:column; gap:10px}
    .msg{max-width:82%; padding:10px 14px; border-radius:12px; line-height:1.38; color:#0b1220; word-wrap:break-word}
    .msg.bot{align-self:flex-start; background:var(--bot); color:var(--botText)}
    .msg.user{align-self:flex-end; background:var(--user); color:var(--userText)}
    .msg.agent{align-self:flex-end; background:var(--agent); color:var(--agentText)}
    .foot{padding:12px; border-top:1px solid var(--border); display:flex; gap:10px; align-items:center; justify-content:center}
    .btn{border:0; background:#fff; color:#0f172a; border-radius:999px; padding:10px 18px; font-weight:800; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .btn.primary{background:var(--accent); color:#06233a}
    .hint{font-size:12px; opacity:.85}

    /* KPI area */
    .kpi{
      display:grid; grid-template-columns: 1fr; gap:12px;
      padding:12px 16px; border-top:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    }
    .krow{
      display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
      background: rgba(255,255,255,.08); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px;
    }
    .knum{font-size:26px; font-weight:900}
    canvas{width:100%; height:140px; background:#00000011; border-radius:10px}

    /* Modal specs — visible y contrastado */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:9999; background:rgba(0,0,0,.65);
      backdrop-filter: blur(2px);
    }
    .modal.open{display:flex}
    .box{
      width:min(960px,95vw); max-height:90vh; overflow:auto;
      background:#0b1530;
      border:1px solid rgba(255,255,255,.22);
      border-radius:16px; box-shadow:0 24px 60px rgba(0,0,0,.6);
      padding:18px; color:#eaf2ff;
    }
    .box h2{margin:0 0 10px 0; font-size:26px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    .pane{background:#111c3d; border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:14px}
    .pane h3{margin:0 0 8px 0}
    .pane ul{margin:0; padding-left:18px; line-height:1.5}
    .pane li{margin:4px 0}
    .modal-actions{display:flex; justify-content:flex-end; margin-top:12px}
    .btn.ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.6)}

    /* Botón inferior para volver a la web */
    .backbar{
      position:fixed; left:0; right:0; bottom:16px; display:flex; justify-content:center; z-index:9998;
      pointer-events:none; /* deja que solo el botón reciba eventos */
    }
    #backBtn{
      pointer-events:auto;
      display:inline-flex; align-items:center; gap:10px;
      background: linear-gradient(135deg, #22d3ee, #2563eb);
      color:#fff; border:0; border-radius:999px;
      padding:14px 22px; font-weight:900; letter-spacing:.2px;
      box-shadow: 0 14px 30px rgba(37,99,235,.35), 0 4px 10px rgba(0,0,0,.25);
      cursor:pointer; transform: translateY(0);
    }
    #backBtn:hover{ filter:brightness(1.06); transform: translateY(-1px); }
    #backBtn:active{ transform: translateY(0); box-shadow: 0 8px 18px rgba(37,99,235,.35), 0 2px 6px rgba(0,0,0,.25); }
    #backBtn .icon{
      width:20px; height:20px; display:inline-block;
      background: currentColor; -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path fill="white" d="M15 18l-6-6 6-6"/></svg>') center / contain no-repeat;
              mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path fill="white" d="M15 18l-6-6 6-6"/></svg>') center / contain no-repeat;
    }

    @media(max-width:980px){
      .wrap{grid-template-columns:1fr; height:auto}
      .grid2{grid-template-columns:1fr}
    }

    /* ====== Agregado: Panel de edición simulado e inactivo ====== */
    .edit-panel{
      display:none;
      position:relative;
      padding:12px 16px;
      border-top:1px solid var(--border);
      background:rgba(255,255,255,.06);
    }
    .edit-panel.open{display:block}
    .edit-panel .label{font-weight:800}
    .edit-options{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .chip{
      padding:8px 10px; border:1px solid var(--border);
      border-radius:10px; background:rgba(255,255,255,.08);
      font-size:12px; opacity:.85;
    }
    .chip.inactive{cursor:not-allowed; filter:grayscale(35%); opacity:.75}
    .ghost-btn{
      display:inline-block; padding:6px 10px; border-radius:8px;
      border:1px solid var(--border); background:rgba(255,255,255,.14);
      font-weight:700; font-size:12px; cursor:not-allowed; opacity:.95
    }
    /* Previsualización fija, no tapa el flujo principal */
    .preview-card{
      display:none;
      position:fixed; right:20px; bottom:100px; z-index:60;
      width:min(360px, 42vw);
      background:#0b1530; border:1px solid var(--border);
      border-radius:12px; box-shadow:0 18px 44px rgba(0,0,0,.45); overflow:hidden
    }
    .preview-head{padding:10px 12px; background:var(--glass2); border-bottom:1px solid var(--border); font-size:14px; font-weight:800}
    .preview-body{padding:0}
    .preview-img{display:block; width:100%; height:180px; object-fit:cover}
    .preview-title{padding:10px 12px; font-size:16px; font-weight:900}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Izquierda: cliente <-> chatbot -->
    <div class="card">
      <div class="head">
        <div>
          <div class="title">Chat con el Asistente</div>
          <div class="sub" id="roomTag">Habitación</div>
        </div>
        <div class="hint">Cliente #1</div>
      </div>

      <div class="log" id="chatLeft"></div>
      <div class="foot">
        <button class="btn primary" id="next">Continuar</button>
        <span class="hint">Único botón accionable</span>
      </div>
    </div>

    <!-- Derecha: Agente (Telegram simulado) + KPIs -->
    <div class="card">
      <div class="head">
        <div class="title">Agente (Telegram)</div>
        <div class="sub">Relay de preguntas complejas</div>
      </div>
      <div class="log" id="chatRight"></div>

      <div class="kpi">
        <div class="krow">
          <div>
            <div style="font-weight:800">Reservas del día</div>
            <div class="sub">Confirmadas por el agente</div>
          </div>
          <div class="knum" id="kpiCount">0</div>
        </div>
        <div style="background: rgba(255,255,255,.08); border:1px solid var(--border); padding:10px 12px; border-radius:12px;">
          <div class="sub" style="margin-bottom:8px">Evolución (hoy)</div>
          <canvas id="kpiChart" width="400" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón inferior: Volver a la web -->
  <div class="backbar">
    <button id="backBtn" title="Volver a la página web">
      <span class="icon"></span> Volver a la página web
    </button>
  </div>

  <!-- MODAL: ¿Qué puede hacer este sistema? -->
  <div class="modal" id="specModal" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="specTitle">
      <h2 id="specTitle">¿Qué puede hacer este sistema?</h2>
      <div class="grid2">
        <div class="pane">
          <h3>Chatbot Web (Clientes / Público)</h3>
          <ul>
            <li>Presentación y bienvenida automatizada.</li>
            <li>Consulta de disponibilidad en Google Sheets.</li>
            <li>Visualización de habitaciones con imágenes, precios y servicios.</li>
            <li>Lightbox con imagen completa y descripción.</li>
            <li>Proceso guiado de reserva y registro automático en Sheets.</li>
            <li>Botón “Asistente personal” para contacto humano (handoff con Telegram).</li>
            <li>Integración con Google Sheets, QuickChart.js y AIntegrity API.</li>
          </ul>
        </div>
        <div class="pane">
          <h3>Agente Telegram (Dueños / Managers)</h3>
          <ul>
            <li><b>Gestión de reservas</b>
              <ul>
                <li>Consulta y actualización del estado de cada reserva.</li>
                <li>Confirmación o cancelación manual.</li>
                <li>Acceso a datos del cliente (nombre, fechas, habitación, contacto).</li>
                <li>Registro automático de nuevas reservas desde el chat web.</li>
              </ul>
            </li>
            <li><b>Disponibilidad y calendario</b>
              <ul>
                <li>Consulta de disponibilidad por fechas o tipo de habitación.</li>
                <li>Bloquear o liberar fechas específicas.</li>
                <li>Sincronización automática con Google Sheets.</li>
              </ul>
            </li>
            <li><b>Gestión de habitaciones y tarifas</b>
              <ul>
                <li>Listado completo con precios y estado.</li>
                <li>Edición de precios, promos o actualización masiva.</li>
                <li>Activar / desactivar habitaciones temporalmente.</li>
              </ul>
            </li>
            <li><b>Estadísticas y reportes</b>
              <ul>
                <li>Gráficos con QuickChart (ocupación, ingresos, rendimiento mensual).</li>
                <li>Métricas diarias, semanales o mensuales.</li>
                <li>Envío automático de reportes al manager.</li>
              </ul>
            </li>
            <li><b>Gestión de contenido (CMS)</b>
              <ul>
                <li>Editar textos del sitio, políticas y descripciones.</li>
                <li>Flujo: <i>borrador → previsualización → publicación</i>.</li>
                <li>Subir o cambiar fotos desde Telegram.</li>
              </ul>
            </li>
            <li><b>Alertas y notificaciones</b>
              <ul>
                <li>Nuevas reservas o cancelaciones.</li>
                <li>Solicitud de asistencia humana desde el chat web.</li>
                <li>Recordatorios configurables (check-in / check-out).</li>
              </ul>
            </li>
            <li><b>Asistente de análisis y soporte</b>
              <ul>
                <li>Resúmenes automáticos del desempeño.</li>
                <li>Sugerencias de optimización de precios y ocupación.</li>
                <li>Responde consultas naturales del manager.</li>
              </ul>
            </li>
            <li><b>Comandos principales</b>
              <ul>
                <li><code>/start</code>, <code>/help</code>, <code>/disponibilidad</code>, <code>/reserva</code>, <code>/estado</code>, <code>/resumen</code>, <code>/editar</code>.</li>
              </ul>
            </li>
            <li><b>Seguridad y control</b>
              <ul>
                <li>Acceso restringido a usuarios autorizados.</li>
                <li>Verificación por ID de Telegram y permisos.</li>
                <li>Registro de acciones críticas.</li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="closeSpec">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- ====== Agregado: Panel de edición simulado (inactivo) ====== -->
  <div id="editPanel" class="edit-panel" aria-hidden="true">
    <div class="label">Panel de edición</div>
    <div class="edit-options">
      <span class="chip inactive">Título</span>
      <span class="chip inactive">Descripción</span>
      <span class="chip inactive">Añadir fotos</span>
      <span class="chip inactive">Políticas</span>
      <span class="chip inactive">Cambiar fondo</span>
    </div>
  </div>

  <!-- ====== Agregado: Ventana de previsualización (no tapa nada) ====== -->
  <div id="previewCard" class="preview-card" aria-hidden="true">
    <div class="preview-head">Previsualización</div>
    <div class="preview-body">
      <img src="img/hotel-1.jpg" alt="Vista del sitio" class="preview-img">
      <div class="preview-title" id="previewTitle">Descansa frente al paraíso tropical</div>
    </div>
  </div>

  <script>
    // === Helpers UI ===
    const L = document.getElementById('chatLeft');
    const R = document.getElementById('chatRight');
    function push(where, who, html){
      const d=document.createElement('div');
      d.className='msg '+who;
      d.innerHTML=html;
      where.appendChild(d);
      where.scrollTop=where.scrollHeight;
    }

    // === Modal helpers ===
    const specModal = document.getElementById('specModal');
    const closeSpec = document.getElementById('closeSpec');
    function openSpecs(){ specModal.classList.add('open'); specModal.setAttribute('aria-hidden','false'); }
    function closeSpecs(){ specModal.classList.remove('open'); specModal.setAttribute('aria-hidden','true'); }
    closeSpec.addEventListener('click', closeSpecs);
    specModal.addEventListener('click', (e)=>{ if(e.target===specModal) closeSpecs(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && specModal.classList.contains('open')) closeSpecs(); });

    // === Back button ===
    document.getElementById('backBtn').addEventListener('click', () => {
      try{
        if (window.history.length > 1 && document.referrer) { window.history.back(); }
        else { window.location.href = './'; }
      } catch { window.location.href = './'; }
    });

    // === Query param: room ===
    const params = new URLSearchParams(location.search);
    const room = (params.get('room') || 'habitación').toLowerCase();
    document.getElementById('roomTag').textContent = 'Habitación: ' + room;

    // === Generadores aleatorios (para simular cliente) ===
    function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function randomName(){
      const first = pick(['Fernando','Valentina','Santiago','Martina','Lautaro','Camila','Julián','Lucía']);
      const last  = pick(['Gómez','Pereyra','López','Fernández','Rojas','Romero','Suárez','Domínguez']);
      return first + ' ' + last;
    }
    function randomEmail(name){
      const base = (name||'user').toLowerCase().replace(/[^a-z]+/g,'.');
      const dom  = pick(['example.com','mail.com','hotelmail.io','correo.ar']);
      return base + randInt(1,99) + '@' + dom;
    }
    function randomPhone(){ return '+54 9 11 ' + randInt(3000,3999) + '-' + randInt(1000,9999); }
    function randomDates(){
      const today = new Date();
      const startOffset = randInt(2, 20);
      const nights = randInt(2, 5);
      const ci = new Date(today.getFullYear(), today.getMonth(), today.getDate()+startOffset);
      const co = new Date(ci.getFullYear(), ci.getMonth(), ci.getDate()+nights);
      const fmt = d => String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear();
      return {ci, co, nights, label: fmt(ci)+' → '+fmt(co)};
    }

    // === KPI mini-chart sin librerías ===
    const ctx = document.getElementById('kpiChart').getContext('2d');
    const kpiSeries = [0];
    function drawChart(){
      const W = ctx.canvas.width, H = ctx.canvas.height;
      ctx.clearRect(0,0,W,H);
      ctx.strokeStyle = 'rgba(255,255,255,.35)';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(30,H-20); ctx.lineTo(W-10,H-20); ctx.stroke();

      const n = kpiSeries.length;
      const bw = Math.max(18, Math.floor((W-60)/(n||1)-6));
      const max = Math.max(1, Math.max.apply(null, kpiSeries));
      for (let i=0;i<n;i++){
        const v = kpiSeries[i];
        const h = Math.round((H-40) * (v/max));
        const x = 40 + i*(bw+6);
        const y = H-20 - h;
        ctx.fillStyle = '#38bdf8';
        ctx.fillRect(x,y,bw,h);
        ctx.fillStyle = 'rgba(255,255,255,.88)';
        ctx.font = '10px Segoe UI';
        ctx.fillText(String(v), x+bw/2-4, y-4);
      }
    }
    function incKPI(){
      const countEl = document.getElementById('kpiCount');
      const current = Number(countEl.textContent||0) + 1;
      countEl.textContent = current;
      kpiSeries.push(current);
      drawChart();
    }
    drawChart();

    // === Variables de simulación (cliente #1) ===
    const C = { name: randomName(), email: null, phone: randomPhone(), dates: randomDates() };
    C.email = randomEmail(C.name);

    // === Guion de la simulación ===
    const steps = [
      // Saludo + datos básicos
      () => push(L, 'bot', `Iniciando simulación de conversación para <b>${room}</b>…`),
      () => push(L, 'bot', `¡Hola! Soy su asistente. ¿Podría indicarme su <b>nombre</b> para asociar la reserva?`),
      () => push(L, 'user', C.name),
      () => push(L, 'bot', `Gracias, <b>${C.name}</b>. ¿Cuál es su <b>correo electrónico</b>?`),
      () => push(L, 'user', C.email),
      () => push(L, 'bot', `Perfecto. ¿Podría confirmarme sus <b>fechas</b> de estadía (check-in y check-out)?`),
      () => push(L, 'user', `Check-in / check-out: ${C.dates.label}  (${C.dates.nights} noches)`),
      () => push(L, 'bot', `Anotado ✅. Por último, ¿me deja un <b>teléfono</b> de contacto?`),
      () => push(L, 'user', C.phone),

      // Conversación normal (manteniendo lo anterior)
      () => push(L, 'bot', `¡Hola! Soy su asistente. Veo que eligió la <b>${room}</b>. ¿Le ayudo con algo más?`),
      () => push(L, 'user', 'Hola, ¿a qué hora es el check-in y el check-out?'),
      () => push(L, 'bot', 'El check-in es a las 14:00 y el check-out a las 11:00.'),
      () => push(L, 'user', '¿Incluye desayuno?'),
      () => push(L, 'bot', 'Sí, desayuno continental incluido.'),

      // Pregunta compleja → Relay a Telegram
      () => push(L, 'user', 'Perfecto. Una pregunta: ¿de qué madera son los muebles de la habitación?'),
      () => {
        push(R, 'bot', `<i>Transcripción automática</i>: <b>Cliente #1</b> pregunta: “¿de qué madera son los muebles de la habitación?”`);
        push(R, 'bot', '<span style="opacity:.85">Enviado a Telegram (simulado)…</span>');
      },
      () => push(R, 'agent', 'Son de cedro.'),

      // Respuesta del agente → vuelta al bot
      () => push(L, 'bot', '<b>Respuesta del manager</b>: Los muebles son de <b>cedro</b> 😊. ¿Desea confirmar la reserva y proceder al pago?'),
      () => push(L, 'user', 'Sí, confirmo y procedo a pagar.'),

      // Pago + creación de reserva
      () => push(L, 'bot', 'Procesando pago… (simulado)'),
      () => push(L, 'bot', '✅ Pago confirmado. ¡Reserva creada!'),
      () => { push(R, 'agent', `Reserva completada para <b>Cliente #1</b> – ${room}.`); incKPI(); },
      () => push(R, 'bot', 'KPI actualizado: +1 reserva registrada en el día.'),

      // ====== Agregado: edición simulada (inactivo) ANTES del cierre ======
      () => push(R, 'agent', '¿Desea editar la página? <span class="ghost-btn" aria-disabled="true" role="button">Editar página</span>'),
      () => {
        push(R, 'agent', '(clic simulado en “Editar página”)');
        const p = document.getElementById('editPanel');
        if (p){ p.classList.add('open'); p.setAttribute('aria-hidden','false'); }
        push(R, 'agent', 'Se abre el panel de edición (opciones inactivas): Título · Descripción · Añadir fotos · Políticas · Cambiar fondo.');
      },
      () => {
        push(R, 'agent', 'El manager elige <b>Cambiar título</b> → título preseleccionado: <b>“Descansa frente al paraíso tropical”</b>.');
      },
      () => {
        const prev = document.getElementById('previewCard');
        const pt = document.getElementById('previewTitle');
        if(prev){ prev.style.display='block'; prev.setAttribute('aria-hidden','false'); }
        if(pt){ pt.textContent = 'Descansa frente al paraíso tropical'; }
        push(R, 'agent', 'Se muestra una previsualización al costado con el nuevo título aplicado.');
      },
      () => {
        push(R, 'agent', '¿Desea confirmar esta edición?');
      },
      () => {
        push(R, 'agent', 'Sí, confirmar.');
      },

      // Cierre (igual que lo tenías)
      () => {
        push(L, 'bot', `🎉 ¡Listo, ${C.name}! Recibirá el voucher en <b>${C.email}</b>. Gracias por elegirnos.`);
        const btn = document.getElementById('next');
        btn.textContent = '¿Qué puede hacer este sistema?';
        btn.onclick = openSpecs; // abre el modal
      }
    ];

    // Botón para avanzar
    let i = 0;
    const nextBtn = document.getElementById('next');
    nextBtn.addEventListener('click', () => { if (i < steps.length){ steps[i++](); } });
  </script>
</body>
</html>
